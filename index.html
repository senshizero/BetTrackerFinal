<!-- Bet Tracker Static Site -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bet Tracker final</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div id="player-select-screen" style="display: none;">
  <h2>Select Players for This Session</h2>
  <form id="player-select-form">
    <label><input type="checkbox" name="players" value="Akash"> Akash</label><br>
    <label><input type="checkbox" name="players" value="Negi"> Negi</label><br>
    <label><input type="checkbox" name="players" value="Prem"> Prem</label><br>
    <label><input type="checkbox" name="players" value="Aabu"> Aabu</label><br><br>
    <button type="submit">Start Game</button>
  </form>
</div>

<div id="main-app" style="display: none;">
  <!-- EXISTING HTML GOES HERE -->

  <h1>üé≤ Bet Tracker</h1>

  <section id="add-player">
    <input id="player-name" placeholder="Enter new player name" />
    <button onclick="addPlayer()">Add Player</button>
  </section>
  <button onclick="nextGame()">‚ûï Next Game</button>
  <section id="transaction">
    <label for="winner">Winner:</label>
    <select id="winner"></select>
    <label for="loser">Loser:</label>
    <select id="loser"></select>
    <label for="amount">Amount (‚Çπ):</label>
    <input id="amount" type="number" placeholder="Enter amount ‚Çπ" />
    <button onclick="addTransaction()">Record Transaction</button>
  </section>

  <h2>üí≥ Debt Table</h2>
  <table id="debt-table" border="1">
    <thead>
      <tr>
        <th>From \ To</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>üìù Transaction Log</h2>
  <table border="1" id="log-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>From</th>
        <th>To</th>
        <th>Amount (‚Çπ)</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>



  <h2>üìú Historical Records (from Google Sheet)</h2>
  <table border="1" id="history-table">
    <thead>
      <tr>
        <th>Time</th>
        <th>From</th>
        <th>To</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <br />
  <a href="https://docs.google.com/spreadsheets/d/1UKp4hyPzIPAi1eQPRWaNB4Qvl-f69x6Im50BLj6pevY/edit?usp=drivesdk">Go to Sheet ‚ÜóÔ∏è</a>
</div>

  <script>
    let currentGame = JSON.parse(localStorage.getItem("currentGame")) || 1;
    
    const PIN = "9211";
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTwHNRhIUYXAfSuBKkk6eZG0fkT4F4oGLwKHUBilhUjc2j7-QhEGbfqEy10XTygJ7XloSUhTgE6EABG/pub?output=csv";
    const SHEET_POST_URL = "https://script.google.com/macros/s/AKfycbxVroFD44BF62p2lIHKFornNhLmkIg6gnvqMuDt-zlQeSCO8cGGccriIAEkFIWtd4Tozg/exec";


    let players = JSON.parse(localStorage.getItem("players"));
    const DEFAULT_PLAYERS = ["Akash", "Negi", "Prem", "Aabu"];
    let debts = JSON.parse(localStorage.getItem("debts")) || {};
    let logs = JSON.parse(localStorage.getItem("logs")) || [];
    let currentGame = JSON.parse(localStorage.getItem("currentGame")) || 1;
    let debts = JSON.parse(localStorage.getItem("debts")) || {};
    let logs = JSON.parse(localStorage.getItem("logs")) || [];

    players.forEach(p => {
      debts[p] = debts[p] || {};
      players.forEach(q => {
        if (p !== q) debts[p][q] = debts[p][q] || 0;
      });
    });

    function nextGame() {
  currentGame++;
  saveAll();
  alert("Started Game " + currentGame);
  renderUI();
    }

    function saveAll() {
  localStorage.setItem("players", JSON.stringify(players));
  localStorage.setItem("debts", JSON.stringify(debts));
  localStorage.setItem("logs", JSON.stringify(logs));
  localStorage.setItem("currentGame", JSON.stringify(currentGame));
    }

    function addPlayer() {
      const name = document.getElementById("player-name").value.trim();
      if (!name || players.includes(name)) return;
      players.push(name);
      players.forEach(p => {
        debts[p] = debts[p] || {};
        players.forEach(other => {
          if (p !== other) debts[p][other] = debts[p][other] || 0;
        });
      });
      saveAll();
      renderUI();
      document.getElementById("player-name").value = "";
    }

    async function deleteTransaction(index) {
  const entered = await promptPin("Enter PIN to delete transaction:");
  if (entered !== PIN) {
    alert("Wrong PIN");
    return;
  }

  const tx = logs[index];
  if (!tx || tx.deleted) return alert("Transaction not found or already deleted.");

  // Perform reverse transaction
  debts[tx.winner][tx.loser] += tx.amount;

  // Mark as deleted
  logs[index].deleted = true;

  rebalanceDebts();
  optimizeTriangularDebts();
  saveAll();
  renderUI();
    }

    
    function renderUI() {
      const winSel = document.getElementById("winner");
      const loseSel = document.getElementById("loser");
      const debtBody = document.querySelector("#debt-table tbody");
      const logBody = document.querySelector("#log-table tbody");

      winSel.innerHTML = loseSel.innerHTML = "";
      players.forEach(name => {
        winSel.innerHTML += `<option value="${name}">${name}</option>`;
        loseSel.innerHTML += `<option value="${name}">${name}</option>`;
      });

      const headerRow = document.querySelector("#debt-table thead tr");
      headerRow.innerHTML = "<th>From \\ To</th>" + players.map(p => `<th>To: ${p}</th>`).join("");

      let tableRows = players.map(p => {
  return `<tr><td>From: ${p}</td>` + players.map(q => `<td>${p === q ? '-' : debts[p][q]}</td>`).join("") + "</tr>";
});

// Calculate net balance for each player
let balances = players.map(player => {
  let totalIn = 0, totalOut = 0;
  players.forEach(other => {
    if (player !== other) {
      totalIn += debts[other][player];   // Money others owe this player
      totalOut += debts[player][other];  // Money this player owes others
    }
  });
  let net = +(totalIn - totalOut).toFixed(2);
  let sign = net > 0 ? "+" : net < 0 ? "-" : "0";
  return { player, net, sign };
});

// Add summary row
const balanceRow = `<tr><td><strong>Net Balance</strong></td>` +
  balances.map(b => {
    let bgColor = b.net > 0 ? "#d4edda" : b.net < 0 ? "#f8d7da" : "transparent";
    let color = b.net > 0 ? "#155724" : b.net < 0 ? "#721c24" : "#333";
    let display = b.net === 0 ? "0" : `${b.sign}‚Çπ${Math.abs(b.net)}`;
    return `<td style="background-color: ${bgColor}; color: ${color}; font-weight: bold;">${display}</td>`;
  }).join("") +
  `</tr>`;

debtBody.innerHTML = tableRows.join("") + balanceRow;

      let grouped = {};

logs.forEach((log, i) => {
  const game = log.game || 1;
  grouped[game] = grouped[game] || [];
  grouped[game].push({ ...log, index: i });
});

logBody.innerHTML = Object.keys(grouped).sort((a,b) => b - a).map(gameNum => {
  const rows = grouped[gameNum].map(log => {
    const isDeleted = log.deleted;
    return `<tr style="${isDeleted ? 'text-decoration: line-through; opacity: 0.5;' : ''}">
      <td>${new Date(log.time).toLocaleString()}</td>
      <td>${log.loser}</td>
      <td>${log.winner}</td>
      <td>‚Çπ${log.amount}</td>
      <td>
        ${isDeleted ? '‚Äî' : `<button onclick="deleteTransaction(${log.index})">‚ùå Delete</button>`}
      </td>
    </tr>`;
  }).join("");

  return `<tr><td colspan="5" style="background: #dfe6e9; font-weight: bold; text-align: left;">üéÆ Game ${gameNum}</td></tr>` + rows;
}).join("");
      saveAll();
    }

    function promptPin(message) {
      const input = document.createElement("input");
      input.type = "number";
      input.inputMode = "numeric";
      input.placeholder = message || "Enter PIN";
      input.style.position = "fixed";
      input.style.top = "50%";
      input.style.left = "50%";
      input.style.transform = "translate(-50%, -50%)";
      input.style.zIndex = 9999;
      input.style.fontSize = "24px";
      input.style.padding = "10px";
      input.setAttribute("pattern", "\\d*");
      document.body.appendChild(input);
      input.focus();
      return new Promise(resolve => {
        input.addEventListener("keydown", function handler(e) {
          if (e.key === "Enter") {
            const value = input.value;
            document.body.removeChild(input);
            resolve(value);
          }
        });
      });
    }

    function rebalanceDebts() {
  for (let i = 0; i < players.length; i++) {
    for (let j = 0; j < players.length; j++) {
      if (i === j) continue;
      const p1 = players[i];
      const p2 = players[j];

      const owe1 = debts[p1][p2] || 0;
      const owe2 = debts[p2][p1] || 0;

      if (owe1 > owe2) {
        debts[p1][p2] = +(owe1 - owe2).toFixed(2);
        debts[p2][p1] = 0;
      } else {
        debts[p2][p1] = +(owe2 - owe1).toFixed(2);
        debts[p1][p2] = 0;
      }
    }
  }
    }
  function optimizeTriangularDebts() {
  for (let i = 0; i < players.length; i++) {
    for (let j = 0; j < players.length; j++) {
      for (let k = 0; k < players.length; k++) {
        if (i === j || j === k || i === k) continue;

        const A = players[i]; // Prem
        const B = players[j]; // Akash
        const C = players[k]; // Negi

        const ab = debts[A][B] || 0; // A ‚Üí B
        const bc = debts[B][C] || 0; // B ‚Üí C

        if (ab > 0 && bc > 0) {
          const transfer = Math.min(ab, bc);
          debts[A][B] -= transfer;
          debts[B][C] -= transfer;
          debts[A][C] += transfer;

          // Clean near-zero floating point leftovers
          if (debts[A][B] < 0.01) debts[A][B] = 0;
          if (debts[B][C] < 0.01) debts[B][C] = 0;
        }
      }
    }
  }
  }

  async function addTransaction() {
  const winner = document.getElementById("winner").value;
  const loser = document.getElementById("loser").value;
  const amount = parseFloat(document.getElementById("amount").value);

  const entered = await promptPin("Enter PIN to confirm transaction:");
  if (entered !== PIN) {
    alert("Wrong PIN");
    return;
  }

  if (!winner || !loser || winner === loser || isNaN(amount) || amount <= 0) return;

  debts[loser][winner] += amount;

  rebalanceDebts();          // Step 1: net direct balances
  optimizeTriangularDebts(); // Step 2: collapse chain debts

  logs.push({ winner, loser, amount, time: Date.now(), game: currentGame });
  saveAll();
  renderUI();
  document.getElementById("amount").value = "";
  }
    
    function fetchSheetData() {
      Papa.parse(SHEET_URL, {
        download: true,
        header: true,
        complete: function(results) {
          const historyTable = document.querySelector("#history-table tbody");
          historyTable.innerHTML = results.data.map(row => {
            return `<tr>
              <td>${row.Time}</td>
              <td>${row.From}</td>
              <td>${row.To}</td>
              <td>${row.Amount}</td>
            </tr>`;
          }).join("");
        }
      });
    }

    window.onload = () => {
  if (!players) {
    // First time load ‚Äî show player selection screen
    document.getElementById("player-select-screen").style.display = "block";
  } else {
    document.getElementById("main-app").style.display = "block";
    renderUI();
    fetchSheetData();
  }
};

    document.getElementById("player-select-form").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  const selected = formData.getAll("players");

  if (selected.length < 2) {
    alert("Please select at least 2 players.");
    return;
  }

  players = selected;
  players.forEach(p => {
    debts[p] = debts[p] || {};
    players.forEach(q => {
      if (p !== q) debts[p][q] = debts[p][q] || 0;
    });
  });

  saveAll();

  document.getElementById("player-select-screen").style.display = "none";
  document.getElementById("main-app").style.display = "block";

  renderUI();
  fetchSheetData();
});

    window.onbeforeunload = function(e) {
      e.preventDefault();
      e.returnValue = 'Are you sure you want to reload?';
    }

    document.addEventListener('gesturestart', function(e) {
      e.preventDefault();
    });
  </script>
</body>
</html>
